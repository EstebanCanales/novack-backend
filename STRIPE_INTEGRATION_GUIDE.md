# Stripe Payment System Integration Guide

This document provides instructions for configuring and testing the Stripe payment system integration.

## 1. Configuration

To enable Stripe integration, you need to configure the following environment variables. Add these to your `.env` file or your environment configuration system:

```
STRIPE_PUBLIC_KEY=pk_test_your_stripe_public_key
STRIPE_SECRET_KEY=sk_test_your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=whsec_your_stripe_webhook_signing_secret
CLIENT_APP_URL=http://localhost:3001 # Base URL of your client application (for checkout redirects)
```

*   `STRIPE_PUBLIC_KEY`: Your Stripe publishable key.
*   `STRIPE_SECRET_KEY`: Your Stripe secret key. This key should be kept confidential and only used on the server-side.
*   `STRIPE_WEBHOOK_SECRET`: The signing secret for your Stripe webhook endpoint. This is used to verify that incoming webhook events are genuinely from Stripe. You can find this in your Stripe Dashboard under Webhooks > [Your Endpoint] > Signing secret.
*   `CLIENT_APP_URL`: The base URL of your frontend application. This is used to construct the `success_url` and `cancel_url` for Stripe Checkout redirects.

## 2. API Endpoints

The Stripe integration introduces the following API endpoints:

### 2.1. Create Checkout Session

*   **Endpoint:** `POST /stripe/checkout/session`
*   **Description:** Creates a new Stripe Checkout session for a supplier to subscribe to a plan.
*   **Authentication:** This endpoint should be protected and accessible only by authenticated users authorized to create subscriptions for a supplier.
*   **Request Body:**
    ```json
    {
      "supplierId": "uuid_of_the_supplier",
      "priceId": "price_stripe_price_id"
    }
    ```
    *   `supplierId` (string, required): The unique identifier of the supplier in your local database.
    *   `priceId` (string, required): The ID of the Stripe Price object that the supplier is subscribing to (e.g., `price_1JGQZyL0qF2QX7ZQx7ZQx7ZQ`).
*   **Success Response (201 Created):**
    ```json
    {
      "sessionId": "cs_test_a1b2c3d4e5f6g7h8i9j0..."
    }
    ```
    *   `sessionId`: The ID of the Stripe Checkout session. The client application should use this ID to redirect the user to Stripe Checkout using `stripe.redirectToCheckout({ sessionId: session.id })`.
*   **Error Responses:**
    *   `400 Bad Request`: If `supplierId` or `priceId` is missing.
    *   `500 Internal Server Error`: If there's an issue creating the checkout session on the server or communicating with Stripe.

### 2.2. Stripe Webhook Handler

*   **Endpoint:** `POST /stripe/webhook`
*   **Description:** Handles incoming webhook events from Stripe. This endpoint is responsible for synchronizing subscription statuses, payment events, and other relevant information between Stripe and your local database.
*   **Authentication:** This endpoint is public but secured by Stripe signature verification. Only requests with a valid `Stripe-Signature` header will be processed.
*   **Request Body:** The request body should be the raw JSON payload sent by Stripe. The server is configured to parse this raw body for signature verification.
*   **Headers:**
    *   `Stripe-Signature`: Required. The signature generated by Stripe, used to verify the authenticity of the event.
*   **Success Response (200 OK):**
    ```json
    {
      "received": true
    }
    ```
*   **Error Responses:**
    *   `400 Bad Request`: If the `Stripe-Signature` is missing or invalid.
    *   `500 Internal Server Error`: If there's an error during event processing. Stripe will typically retry sending the webhook if it doesn't receive a 2xx response.

**Supported Webhook Events:**
The system is configured to handle (at minimum) the following events:
*   `checkout.session.completed`: When a customer successfully completes a Stripe Checkout session.
*   `invoice.payment_succeeded`: When an invoice (including for a subscription renewal) is successfully paid.
*   `invoice.payment_failed`: When an invoice payment fails.
*   `customer.subscription.updated`: When a subscription's details change (e.g., status, plan, period end).
*   `customer.subscription.deleted`: When a subscription is canceled/deleted.

## 3. Setting Up Products and Prices in Stripe

Before using the checkout system, you must define Products and their corresponding Prices in your Stripe Dashboard:

1.  **Log in to your Stripe Dashboard.**
2.  Navigate to **Products**.
3.  Click **+ Add product**.
    *   Define a **Name** for your product (e.g., "Basic Plan", "Pro Plan").
    *   (Optional) Add a description, image, etc.
4.  Once the product is created, click **+ Add a price**.
    *   Choose a **Pricing model** (e.g., Standard pricing, Package pricing).
    *   Set the **Price** amount and currency.
    *   Select **Recurring** for subscription plans and define the billing period (e.g., monthly, yearly).
    *   (Optional) Add a description for the price.
5.  After creating a price, Stripe will assign it a **Price ID** (e.g., `price_1JGQZyL0qF2QX7ZQx7ZQx7ZQ`). This is the `priceId` you will use when calling the "Create Checkout Session" endpoint.
6.  Repeat for all subscription plans you offer.

## 4. Testing the Integration

Thorough testing is crucial for payment integrations. Use Stripe's test mode for all testing.

### 4.1. Using Stripe Test Cards

Stripe provides a set of test card numbers that can be used in test mode to simulate various payment scenarios, including successful payments, declined cards, and cards requiring authentication.
Refer to the official Stripe documentation for a list of test card numbers: [https://stripe.com/docs/testing#cards](https://stripe.com/docs/testing#cards)

### 4.2. Testing Webhooks

You can test your webhook endpoint in several ways:

*   **Stripe Dashboard:** Manually send test events from the Stripe Dashboard (Webhooks > [Your Endpoint] > Send test event).
*   **Stripe CLI:** The Stripe CLI is a powerful tool for testing webhooks locally. You can use it to:
    1.  Install the Stripe CLI: [https://stripe.com/docs/stripe-cli](https://stripe.com/docs/stripe-cli)
    2.  Log in: `stripe login`
    3.  Forward events to your local webhook endpoint:
        ```bash
        stripe listen --forward-to localhost:3000/stripe/webhook
        ```
        (Replace `localhost:3000` with your local server's address and port if different.)
    4.  Trigger events by performing actions in your application (e.g., completing a test checkout) or by using the Stripe CLI to trigger specific events:
        ```bash
        stripe trigger checkout.session.completed --add checkout_session:metadata.app_supplier_id="your_supplier_id" --add checkout_session:metadata.stripe_price_id="your_price_id"
        ```
        (You may need to customize the trigger command to include necessary metadata for your handlers.)

### 4.3. Key Testing Scenarios (Manual Checklist)

*   [ ] **Successful Subscription Creation:**
    1.  Call `POST /stripe/checkout/session` with a valid `supplierId` and `priceId`.
    2.  Use the returned `sessionId` to complete the checkout in a browser using Stripe test cards.
    3.  Verify that the `checkout.session.completed` webhook is received and processed.
    4.  Check your local database: `SupplierSubscription` should be marked as active (`is_subscribed` = true), and `stripe_customer_id`, `stripe_subscription_id`, `stripe_price_id`, `subscription_status`, and `subscription_end_date` should be populated correctly.
*   [ ] **Subscription Renewal (Simulated):**
    1.  After a subscription is active, wait for Stripe to (theoretically) attempt a renewal or use the Stripe Dashboard/CLI to trigger an `invoice.payment_succeeded` event for the existing subscription.
    2.  Verify the webhook is processed and `subscription_end_date` is updated in your local database.
*   [ ] **Payment Failure:**
    1.  Simulate a payment failure during checkout using a test card that causes failures.
    2.  If a subscription is active, you can simulate a renewal failure (Stripe has specific test cards or scenarios for this, or you might need to update the payment method on a test customer in Stripe to a failing one).
    3.  Verify `invoice.payment_failed` webhook is received.
    4.  Verify `customer.subscription.updated` shows a status like `past_due`. Check local DB for status update.
*   [ ] **Subscription Cancellation:**
    1.  (If UI exists) Cancel a subscription through your application, which should call Stripe API to cancel.
    2.  Alternatively, cancel the subscription directly from the Stripe Dashboard for a test customer.
    3.  Verify `customer.subscription.deleted` or `customer.subscription.updated` (with status `canceled`) webhook is received.
    4.  Check local database: `SupplierSubscription` should be marked inactive (`is_subscribed` = false, `subscription_status` = 'canceled' or 'deleted').

## 5. Idempotency

Webhook handlers should be idempotent, meaning processing the same event multiple times should not result in errors or incorrect data. The current implementation relies on the `SupplierService` methods to handle updates in an idempotent manner (e.g., re-activating an already active subscription). If Stripe retries sending a webhook (due to network issues or non-2xx responses from your endpoint), the system should handle this gracefully.

---
This guide should help in setting up, using, and testing the Stripe integration.
